<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö° SolarMap - An√°lise de Potencial Solar ‚ö°</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.css">

    <!-- CSS Customizado -->
    <link rel="stylesheet" href="css/style.css">

    <style>
        .main-title { margin-bottom: 30px !important; }
        .main-subtitle { margin-top: 0 !important; line-height: 1.6; }
        .info-card h4 { font-size: 13px; margin-bottom: 8px; line-height: 1.3; }

        /* ================================
           GATE DO FORMUL√ÅRIO (BLOQUEIO)
           ================================ */
        #form-gate {
            position: fixed;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            background: #0f172a;
            z-index: 999999;
            display: none; /* CONTROLADO VIA JS */
            align-items: center;
            justify-content: center;
            padding: 18px;
            box-sizing: border-box;
        }
        .form-gate-card {
            width: 95%;
            max-width: 900px;
            background: #ffffff;
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.45);
            border: 1px solid rgba(0,0,0,0.06);
        }
        .form-gate-header {
            padding: 16px 18px;
            background: linear-gradient(135deg, #1e3a5f, #0b1220);
            color: #fff;
            font-family: Arial, sans-serif;
        }
        .form-gate-header h2 { margin: 0; font-size: 16px; font-weight: 700; }
        .form-gate-header p { margin: 6px 0 0 0; font-size: 12px; opacity: 0.9; line-height: 1.4; }
        .form-gate-iframe { width: 100%; height: 62vh; border: 0; }
        .form-gate-footer {
            padding: 16px 18px;
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: center;
            background: #fafafa;
            border-top: 1px solid #eee;
            font-family: Arial, sans-serif;
            flex-wrap: wrap;
        }
        .form-gate-footer button {
            background: #1e3a5f;
            color: #fff;
            padding: 12px 18px;
            border-radius: 10px;
            border: none;
            font-size: 15px;
            cursor: pointer;
            font-weight: 700;
        }
        .form-gate-footer button:hover { filter: brightness(1.05); }
        .form-gate-footer a { font-size: 13px; color: #1e3a5f; text-decoration: underline; }
        .gate-input {
            padding: 12px 12px;
            border-radius: 10px;
            border: 1px solid #ddd;
            min-width: 280px;
            font-size: 14px;
            outline: none;
        }
        .gate-msg { width: 100%; text-align: center; font-size: 13px; margin-top: 6px; }
        .gate-small { font-size: 12px; color: #333; opacity: 0.85; width: 100%; text-align: center; }
        .btn-secondary { background: #64748b !important; }
    </style>
</head>
<body>

    <!-- ================================
         BLOQUEIO: FORMUL√ÅRIO OBRIGAT√ìRIO (VALIDA√á√ÉO REAL)
         ================================ -->
    <div id="form-gate">
        <div class="form-gate-card">
            <div class="form-gate-header">
                <h2>üìù Formul√°rio obrigat√≥rio para acesso</h2>
                <p>
                    Preencha e envie o formul√°rio. Em seguida, informe o <strong>mesmo e-mail</strong> utilizado no envio para liberar o acesso.
                </p>
            </div>

            <iframe
                class="form-gate-iframe"
                src="https://forms.gle/kavgEs2JZM8zA84o9"
                loading="lazy"
                referrerpolicy="no-referrer-when-downgrade"
                title="Formul√°rio de acesso SolarMap">
            </iframe>

            <div class="form-gate-footer">
                <input id="gate-email" class="gate-input" type="email" placeholder="Digite o e-mail usado no formul√°rio" />

                <button type="button" onclick="validarEmail()">üîì Validar e acessar</button>

                <button type="button" class="btn-secondary" onclick="limparAcesso()" title="Limpa o e-mail digitado">
                    üîÑ Limpar
                </button>

                <a href="https://forms.gle/kavgEs2JZM8zA84o9" target="_blank" rel="noopener">
                    Abrir formul√°rio em nova aba
                </a>

                <div id="gate-msg" class="gate-msg"></div>
                <div class="gate-small">
                    Desenvolvido Pela Solar Map - Solu√ß√µes inteligentes
                </div>
            </div>
        </div>
    </div>

    <!-- Container principal -->
    <div id="main-dashboard">
        <!-- (SEU CONTE√öDO INTEIRO SEM ALTERA√á√ÉO) -->
        <!-- Header com v√≠deo de fundo -->
        <div class="header-container">
            <video autoplay loop muted class="background-video">
                <source src="assets/video.mp4" type="video/mp4">
            </video>
            <div class="header-overlay"></div>
            <div class="header-content">
                <h1 class="main-title">‚ö° SolarMap - An√°lise de Potencial Solar ‚ö°</h1>
                <p class="main-subtitle">
                    Plataforma inteligente para identifica√ß√£o de oportunidades em energia solar fotovoltaica com base em an√°lise geoespacial e dados t√©cnicos.
                </p>
            </div>
        </div>

        <!-- Cards de resumo din√¢micos -->
        <div class="summary-cards">
            <div class="summary-card">
                <h4>üìä Total de Im√≥veis</h4>
                <p id="total-imoveis-display">Carregando...</p>
            </div>
            <div class="summary-card">
                <h4>‚ö° Produ√ß√£o Total (kW)</h4>
                <p id="producao-total-display">Carregando...</p>
            </div>
            <div class="summary-card">
                <h4>üìà M√©dia por Im√≥vel (kW)</h4>
                <p id="media-imovel-display">Carregando...</p>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filter-container">
            <h3>üîç Filtros</h3>
            <div class="filter-grid">
                <div class="filter-group">
                    <label for="bairro-select">Bairros:</label>
                    <select id="bairro-select">
                        <option value="">Carregando bairros...</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="info-select">Informa√ß√£o:</label>
                    <select id="info-select">
                        <option value="capacidade_por_m2">Capacidade por m¬≤</option>
                        <option value="producao_telhado">Produ√ß√£o do Telhado</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Valores:</label>
                    <div class="value-inputs">
                        <input type="number" id="min-value" placeholder="M√≠n">
                        <input type="number" id="max-value" placeholder="M√°x">
                        <button id="reset-button">üîÑ Limpar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status de Carregamento -->
        <div id="loading-status" style="
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 20px;
            text-align: center;
            font-family: Arial, sans-serif;
            display: none;
        ">
            <div id="loading-text">üîÑ Carregando dados...</div>
            <div id="loading-details" style="font-size: 12px; color: #666; margin-top: 5px;"></div>
        </div>

        <!-- Mapa -->
        <div class="map-container"><div id="map"></div></div>

        <!-- Gr√°ficos -->
        <div class="charts-container">
            <div class="chart-box"><canvas id="grafico-producao"></canvas></div>
            <div class="chart-box"><canvas id="grafico-radiacao"></canvas></div>
        </div>

        <!-- (restante do seu HTML permanece igual...) -->
        <!-- Se√ß√£o de contato e footer tamb√©m permanecem iguais -->
    </div>

    <!-- 1. Bibliotecas Base -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <!-- 2. Script de inicializa√ß√£o -->
    <script>
console.log('üîÑ Iniciando SolarMap...');

const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxHOZD-5z8NKNnJLHEOBKWEB8hxWA1vxTNnsLHhyJYUNnzBS2fyDg1etG-O3NITcQA2Vg/exec";

let currentSessionId = null;

// =============================
// GATE
// =============================
function setGateMsg(msg, ok = false) {
    const el = document.getElementById("gate-msg");
    if (!el) return;
    el.style.color = ok ? "#16a34a" : "#dc2626";
    el.textContent = msg;
}

function mostrarGate() {
    const gate = document.getElementById('form-gate');
    if (gate) gate.style.display = "flex";
}

function esconderGate() {
    const gate = document.getElementById('form-gate');
    if (gate) gate.style.display = "none";
}

function limparAcesso() {
    const input = document.getElementById("gate-email");
    if (input) input.value = "";
    setGateMsg("Informe o e-mail novamente.", true);
    mostrarGate();
}

// Sempre mostrar gate ao carregar
mostrarGate();

// =============================
// JSONP helper
// =============================
function jsonp(url) {
    return new Promise((resolve, reject) => {
        const script = document.createElement("script");
        const cb = "cb_" + Date.now() + "_" + Math.floor(Math.random() * 10000);

        window[cb] = (data) => {
            resolve(data);
            try { delete window[cb]; } catch(e) {}
            script.remove();
        };

        script.onerror = () => {
            reject(new Error("Falha JSONP"));
            try { delete window[cb]; } catch(e) {}
            script.remove();
        };

        script.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;
        document.body.appendChild(script);
    });
}

// =============================
// VALIDAR EMAIL + LOG START
// =============================
async function validarEmail() {

    const input = document.getElementById("gate-email");
    const email = (input?.value || "").trim().toLowerCase();

    if (!email || !email.includes("@")) {
        setGateMsg("Digite um e-mail v√°lido.");
        return;
    }

    setGateMsg("Verificando envio no formul√°rio...", true);

    try {
        // 1Ô∏è‚É£ VERIFY
        const verifyUrl = `${SCRIPT_URL}?email=${encodeURIComponent(email)}`;
        const verifyRes = await jsonp(verifyUrl);

        if (!verifyRes || !verifyRes.ok) {
            setGateMsg("Acesso negado: e-mail n√£o encontrado.");
            return;
        }

        // 2Ô∏è‚É£ LOG START
        const startUrl =
            `${SCRIPT_URL}?action=log_start` +
            `&email=${encodeURIComponent(email)}` +
            `&ua=${encodeURIComponent(navigator.userAgent)}` +
            `&page=${encodeURIComponent(location.href)}`;

        const startRes = await jsonp(startUrl);

        if (startRes && startRes.ok) {
            currentSessionId = startRes.sessionId;
            console.log("üü¢ Sess√£o iniciada:", currentSessionId);
        }

        esconderGate();
        setGateMsg("Acesso liberado!", true);

    } catch (err) {
        console.error(err);
        setGateMsg("Erro ao validar. Tente novamente.");
    }
}

window.validarEmail = validarEmail;
window.limparAcesso = limparAcesso;

// =============================
// LOG END (ao sair)
// =============================
window.addEventListener("beforeunload", function () {

    if (!currentSessionId) return;

    navigator.sendBeacon(
        SCRIPT_URL,
        JSON.stringify({
            action: "log_end",
            sessionId: currentSessionId
        })
    );

    console.log("üî¥ Sess√£o finalizada:", currentSessionId);
});

// =============================
// ===== SEU LOADER ORIGINAL =====
// =============================

function updateLoadingStatus(text, details = '') {
    const statusDiv = document.getElementById('loading-status');
    const textDiv = document.getElementById('loading-text');
    const detailsDiv = document.getElementById('loading-details');

    if (statusDiv && textDiv) {
        statusDiv.style.display = 'block';
        textDiv.textContent = text;
        if (detailsDiv) detailsDiv.textContent = details;
    }
}

function hideLoadingStatus() {
    const statusDiv = document.getElementById('loading-status');
    if (statusDiv) statusDiv.style.display = 'none';
}

function loadScriptSync(src, description = '') {
    return new Promise((resolve, reject) => {
        updateLoadingStatus('üîÑ Carregando...', description || src);

        const script = document.createElement('script');
        script.src = src;
        script.onload = () => resolve();
        script.onerror = () => reject(new Error(`Falha ao carregar: ${src}`));
        document.head.appendChild(script);
    });
}

async function initializeSolarMap() {
    try {
        await loadScriptSync('https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js');
        await loadScriptSync('js/dashboard.js');
        await loadScriptSync('js/map.js');
        await loadScriptSync('js/charts.js');
        await loadScriptSync('js/filters.js');

        if (typeof initializeDashboard === 'function') {
            await initializeDashboard();
        }

        hideLoadingStatus();

    } catch (error) {
        console.error('Erro na inicializa√ß√£o:', error);
    }
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeSolarMap);
} else {
    initializeSolarMap();
}
</script>
</body>
</html>
