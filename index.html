<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö° SolarMap - An√°lise de Potencial Solar ‚ö°</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.css">

    <!-- CSS Customizado -->
    <link rel="stylesheet" href="css/style.css">

    <!-- CSS adicional para ajustes espec√≠ficos -->
    <style>
        /* CORRE√á√ÉO: Ajustar espa√ßamento do t√≠tulo para subt√≠tulo */
        .main-title {
            margin-bottom: 30px !important; /* Aumentar dist√¢ncia */
        }

        .main-subtitle {
            margin-top: 0 !important;
            line-height: 1.6;
        }

        /* Melhorar apar√™ncia dos cards */
        .info-card h4 {
            font-size: 13px;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        /* ================================
           GATE DO FORMUL√ÅRIO (BLOQUEIO)
           ================================ */
        #form-gate {
            position: fixed;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            background: #0f172a;
            z-index: 999999;
            display: none; /* CONTROLADO VIA JS */
            align-items: center;
            justify-content: center;
            padding: 18px;
            box-sizing: border-box;
        }
        .form-gate-card {
            width: 95%;
            max-width: 900px;
            background: #ffffff;
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.45);
            border: 1px solid rgba(0,0,0,0.06);
        }
        .form-gate-header {
            padding: 16px 18px;
            background: linear-gradient(135deg, #1e3a5f, #0b1220);
            color: #fff;
            font-family: Arial, sans-serif;
        }
        .form-gate-header h2 {
            margin: 0;
            font-size: 16px;
            font-weight: 700;
        }
        .form-gate-header p {
            margin: 6px 0 0 0;
            font-size: 12px;
            opacity: 0.9;
            line-height: 1.4;
        }
        .form-gate-iframe {
            width: 100%;
            height: 62vh;
            border: 0;
        }
        .form-gate-footer {
            padding: 16px 18px;
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: center;
            background: #fafafa;
            border-top: 1px solid #eee;
            font-family: Arial, sans-serif;
            flex-wrap: wrap;
        }
        .form-gate-footer button {
            background: #1e3a5f;
            color: #fff;
            padding: 12px 18px;
            border-radius: 10px;
            border: none;
            font-size: 15px;
            cursor: pointer;
            font-weight: 700;
        }
        .form-gate-footer button:hover {
            filter: brightness(1.05);
        }
        .form-gate-footer a {
            font-size: 13px;
            color: #1e3a5f;
            text-decoration: underline;
        }
        .gate-input {
            padding: 12px 12px;
            border-radius: 10px;
            border: 1px solid #ddd;
            min-width: 280px;
            font-size: 14px;
            outline: none;
        }
        .gate-msg {
            width: 100%;
            text-align: center;
            font-size: 13px;
            margin-top: 6px;
        }
        .gate-small {
            font-size: 12px;
            color: #333;
            opacity: 0.85;
            width: 100%;
            text-align: center;
        }
        .btn-secondary {
            background: #64748b !important;
        }
    </style>
</head>
<body>

    <!-- ================================
         BLOQUEIO: FORMUL√ÅRIO OBRIGAT√ìRIO (VALIDA√á√ÉO REAL)
         ================================ -->
    <div id="form-gate">
        <div class="form-gate-card">
            <div class="form-gate-header">
                <h2>üìù Formul√°rio obrigat√≥rio para acesso</h2>
                <p>
                    Preencha e envie o formul√°rio. Em seguida, informe o <strong>mesmo e-mail</strong> utilizado no envio para liberar o acesso.
                </p>
            </div>

            <iframe
                class="form-gate-iframe"
                src="https://forms.gle/kavgEs2JZM8zA84o9"
                loading="lazy"
                referrerpolicy="no-referrer-when-downgrade"
                title="Formul√°rio de acesso SolarMap">
            </iframe>

            <div class="form-gate-footer">
                <input id="gate-email" class="gate-input" type="email" placeholder="Digite o e-mail usado no formul√°rio" />

                <button type="button" onclick="validarEmail()">üîì Validar e acessar</button>

                <button type="button" class="btn-secondary" onclick="limparAcesso()" title="Limpa o acesso salvo e permite validar outro e-mail">
                    üîÑ Trocar e-mail
                </button>

                <a href="https://forms.gle/kavgEs2JZM8zA84o9" target="_blank" rel="noopener">
                    Abrir formul√°rio em nova aba
                </a>

                <div id="gate-msg" class="gate-msg"></div>
                <div class="gate-small">
                    Dica: o acesso libera quando o sistema encontrar seu e-mail nas respostas do formul√°rio.
                </div>
            </div>
        </div>
    </div>

    <!-- Container principal -->
    <div id="main-dashboard">
        <!-- Header com v√≠deo de fundo -->
        <div class="header-container">
            <!-- V√≠deo de fundo -->
            <video autoplay loop muted class="background-video">
                <source src="assets/video.mp4" type="video/mp4">
            </video>

            <!-- Overlay -->
            <div class="header-overlay"></div>

            <!-- Conte√∫do do header -->
            <div class="header-content">
                <h1 class="main-title">‚ö° SolarMap - An√°lise de Potencial Solar ‚ö°</h1>
                <p class="main-subtitle">
                    Plataforma inteligente para identifica√ß√£o de oportunidades em energia solar fotovoltaica com base em an√°lise geoespacial e dados t√©cnicos.
                </p>
            </div>
        </div>

        <!-- Cards de resumo din√¢micos -->
        <div class="summary-cards">
            <div class="summary-card">
                <h4>üìä Total de Im√≥veis</h4>
                <p id="total-imoveis-display">Carregando...</p>
            </div>
            <div class="summary-card">
                <h4>‚ö° Produ√ß√£o Total (kW)</h4>
                <p id="producao-total-display">Carregando...</p>
            </div>
            <div class="summary-card">
                <h4>üìà M√©dia por Im√≥vel (kW)</h4>
                <p id="media-imovel-display">Carregando...</p>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filter-container">
            <h3>üîç Filtros</h3>
            <div class="filter-grid">
                <div class="filter-group">
                    <label for="bairro-select">Bairros:</label>
                    <select id="bairro-select">
                        <option value="">Carregando bairros...</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="info-select">Informa√ß√£o:</label>
                    <select id="info-select">
                        <option value="capacidade_por_m2">Capacidade por m¬≤</option>
                        <option value="producao_telhado">Produ√ß√£o do Telhado</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Valores:</label>
                    <div class="value-inputs">
                        <input type="number" id="min-value" placeholder="M√≠n">
                        <input type="number" id="max-value" placeholder="M√°x">
                        <button id="reset-button">üîÑ Limpar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status de Carregamento -->
        <div id="loading-status" style="
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 20px;
            text-align: center;
            font-family: Arial, sans-serif;
            display: none;
        ">
            <div id="loading-text">üîÑ Carregando dados...</div>
            <div id="loading-details" style="font-size: 12px; color: #666; margin-top: 5px;"></div>
        </div>

        <!-- Mapa -->
        <div class="map-container">
            <div id="map"></div>
        </div>

        <!-- Gr√°ficos lado a lado -->
        <div class="charts-container">
            <div class="chart-box">
                <canvas id="grafico-producao"></canvas>
            </div>
            <div class="chart-box">
                <canvas id="grafico-radiacao"></canvas>
            </div>
        </div>

        <!-- Cards de informa√ß√µes -->
        <div class="info-section">
            <h3 class="info-title">üìã Detalhes do Im√≥vel Selecionado</h3>

            <!-- Grid de informa√ß√µes -->
            <div class="info-grid">
                <!-- Linha 1 -->
                <div class="info-card">
                    <h4>üè† √Årea (m¬≤)</h4>
                    <p id="area-edificacao-display">0,00</p>
                </div>
                <div class="info-card">
                    <h4>‚òÄÔ∏è Rad. M√°x (kW/m¬≤)</h4>
                    <p id="radiacao-max-display">0,00</p>
                </div>
                <div class="info-card">
                    <h4>‚ö° Capacidade de Produ√ß√£o de energia/m¬≤</h4>
                    <p id="capacidade-por-m2-display">0,00</p>
                </div>
                <div class="info-card">
                    <h4>üîã Prod. Total (kW)</h4>
                    <p id="producao-telhado-display">0,00</p>
                </div>
                <!-- Linha 2 -->
                <div class="info-card">
                    <h4>üå§Ô∏è Prod. Ener Di√°ria da placa em (kWh)</h4>
                    <p id="capacidade-placas-dia-display">0,00</p>
                </div>
                <div class="info-card">
                    <h4>üìÖ Prod. Ener Mensal em (kWh)</h4>
                    <p id="capacidade-placas-mes-display">0,00</p>
                </div>
                <div class="info-card">
                    <h4>üî≤ Qtd. Placas</h4>
                    <p id="quantidade-placas-display">0</p>
                </div>
                <div class="info-card">
                    <h4>üìä Pot. M√©dio (kW.dia.m¬≤)</h4>
                    <p id="potencial-medio-dia-display">0,00</p>
                </div>
                <!-- Linha 3 -->
                <div class="info-card">
                    <h4>üí∞ Renda Total (R$)</h4>
                    <p id="renda-total-display">0,00</p>
                </div>
                <div class="info-card">
                    <h4>üë§ Renda Per Capita (R$)</h4>
                    <p id="renda-per-capita-display">0,00</p>
                </div>
                <div class="info-card">
                    <h4>üè° Renda domiciliar per capita</h4>
                    <p id="renda-domiciliar-per-capita-display">0,00</p>
                </div>
                <div class="info-card invisible"></div>
            </div>
        </div>

        <!-- Relat√≥rio s√≠ntese -->
        <div class="relatorio-section">
            <h3 id="relatorio-titulo">üìä Relat√≥rio S√≠ntese do Im√≥vel</h3>
            <div class="relatorio-content">
                <p id="relatorio-conteudo">
                    Selecione um im√≥vel no mapa para visualizar o relat√≥rio detalhado com todas as informa√ß√µes t√©cnicas e de localiza√ß√£o.
                </p>
            </div>

            <!-- Bot√£o PDF -->
            <div class="pdf-section">
                <button id="btn-gerar-pdf">
                    <i class="fas fa-file-pdf"></i>
                    üìÑ Gerar Relat√≥rio PDF
                </button>

                <!-- Instru√ß√µes PDF -->
                <div id="pdf-instructions" class="pdf-instructions" style="display: none;">
                    <p>
                        <strong>üí° Como gerar PDF:</strong><br>
                        1. Pressione Ctrl+P (Windows) ou Cmd+P (Mac)<br>
                        2. Selecione 'Salvar como PDF'<br>
                        3. Ajuste as margens para 'M√≠nimas'<br>
                        4. Clique em 'Salvar'
                    </p>
                </div>
            </div>
        </div>

        <!-- Debug Panel (apenas em desenvolvimento) -->
        <div id="debug-panel" style="
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-width: 300px;
            display: none;
            z-index: 1000;
        ">
            <div style="font-weight: bold; margin-bottom: 5px;">üîç Debug Info</div>
            <div id="debug-info">
                <div>Dados: <span id="debug-data-count">0</span></div>
                <div>Mapa: <span id="debug-map-status">‚ùå</span></div>
                <div>Pol√≠gonos: <span id="debug-polygons-count">0</span></div>
                <div>Bairros: <span id="debug-bairros-count">0</span></div>
            </div>
            <button onclick="toggleDebugPanel()" style="
                background: #007bff;
                color: white;
                border: none;
                padding: 5px 10px;
                border-radius: 4px;
                margin-top: 10px;
                cursor: pointer;
                font-size: 10px;
            ">Fechar</button>
        </div>

        <!-- Se√ß√£o de contato -->
        <div class="contact-section">
            <h3>üìû Contato SolarMap</h3>
            <div class="contact-grid">
                <div class="contact-card">
                    <i class="fab fa-instagram"></i>
                    <h4>Instagram</h4>
                    <a href="https://www.instagram.com/solarmap_/" target="_blank">@solarmap_</a>
                </div>
                <div class="contact-card">
                    <i class="fab fa-whatsapp"></i>
                    <h4>WhatsApp</h4>
                    <a href="https://wa.me/5598986074695" target="_blank">+55 (98) 98607-4695</a>
                </div>
                <div class="contact-card">
                    <i class="fab fa-whatsapp"></i>
                    <h4>WhatsApp</h4>
                    <a href="https://wa.me/5598983331225" target="_blank">+55 (98) 98333-1225</a>
                </div>
                <div class="contact-card">
                    <img src="assets/logo.jpg" alt="SolarMap Logo" class="logo-img">
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>üåü SolarMap - Tecnologia e Sustentabilidade em Energia Solar üåü</p>
        </div>
    </div>

    <!-- Scripts em ordem SIMPLIFICADA - SEM SISTEMA DE MERGE SEPARADO -->

    <!-- 1. Bibliotecas Base -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <!-- 2. Script de inicializa√ß√£o -->
    <script>
        console.log('üîÑ Iniciando carregamento do SolarMap...');

        // ================================
        // BACKEND REAL: URL DO APPS SCRIPT
        // ================================
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxHOZD-5z8NKNnJLHEOBKWEB8hxWA1vxTNnsLHhyJYUNnzBS2fyDg1etG-O3NITcQA2Vg/exec";

        // ================================
        // GATE (VALIDA√á√ÉO REAL POR EMAIL)
        // ================================
        function setGateMsg(msg, ok = false) {
            const el = document.getElementById("gate-msg");
            if (!el) return;
            el.style.color = ok ? "#16a34a" : "#dc2626";
            el.textContent = msg;
        }

        function mostrarGateSeNecessario() {
            const gate = document.getElementById('form-gate');
            if (!gate) return;

            const liberado = localStorage.getItem("formAccessOk") === "true";
            gate.style.display = liberado ? "none" : "flex";
        }

        function limparAcesso() {
            localStorage.removeItem("formAccessOk");
            localStorage.removeItem("formAccessEmail");
            const gate = document.getElementById("form-gate");
            if (gate) gate.style.display = "flex";
            setGateMsg("Acesso limpo. Informe o e-mail novamente.", true);
        }

        // JSONP helper (evita CORS em site est√°tico)
        function jsonp(url) {
            return new Promise((resolve, reject) => {
                const script = document.createElement("script");
                const cb = "cb_" + Date.now() + "_" + Math.floor(Math.random() * 10000);

                window[cb] = (data) => {
                    resolve(data);
                    try { delete window[cb]; } catch(e) {}
                    script.remove();
                };

                script.onerror = () => {
                    reject(new Error("Falha na requisi√ß√£o JSONP"));
                    try { delete window[cb]; } catch(e) {}
                    script.remove();
                };

                // adiciona callback automaticamente
                script.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;
                document.body.appendChild(script);
            });
        }

        async function validarEmail() {
            const input = document.getElementById("gate-email");
            const email = (input?.value || "").trim().toLowerCase();

            if (!email || !email.includes("@")) {
                setGateMsg("Digite um e-mail v√°lido (o mesmo usado no formul√°rio).");
                return;
            }

            setGateMsg("Verificando seu envio no formul√°rio...", true);

            const url = `${SCRIPT_URL}?email=${encodeURIComponent(email)}`;

            try {
                const res = await jsonp(url);

                if (res && res.ok) {
                    localStorage.setItem("formAccessOk", "true");
                    localStorage.setItem("formAccessEmail", email);

                    const gate = document.getElementById("form-gate");
                    if (gate) gate.style.display = "none";

                    setGateMsg("Acesso liberado!", true);
                } else {
                    const detalhe = res?.error ? ` (${res.error})` : "";
                    setGateMsg("Acesso negado: n√£o encontramos esse e-mail nas respostas do formul√°rio." + detalhe);
                }
            } catch (err) {
                console.error(err);
                setGateMsg("Erro ao verificar. Tente novamente em alguns segundos.");
            }
        }

        // Exportar globalmente para onclick funcionar
        window.validarEmail = validarEmail;
        window.limparAcesso = limparAcesso;

        // Mostrar gate o quanto antes
        mostrarGateSeNecessario();

        // ================================
        // Fun√ß√£o para mostrar status de carregamento
        // ================================
        function updateLoadingStatus(text, details = '') {
            const statusDiv = document.getElementById('loading-status');
            const textDiv = document.getElementById('loading-text');
            const detailsDiv = document.getElementById('loading-details');

            if (statusDiv && textDiv) {
                statusDiv.style.display = 'block';
                textDiv.textContent = text;
                if (detailsDiv) {
                    detailsDiv.textContent = details;
                }
            }
            console.log(`üìã ${text} ${details}`);
        }

        // Fun√ß√£o para esconder status de carregamento
        function hideLoadingStatus() {
            const statusDiv = document.getElementById('loading-status');
            if (statusDiv) {
                statusDiv.style.display = 'none';
            }
        }

        // Fun√ß√£o para carregar script de forma s√≠ncrona
        function loadScriptSync(src, description = '') {
            return new Promise((resolve, reject) => {
                updateLoadingStatus('üîÑ Carregando...', description || src);

                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    console.log('‚úÖ Script carregado:', description || src);
                    resolve();
                };
                script.onerror = () => {
                    console.error('‚ùå Erro ao carregar:', description || src);
                    reject(new Error(`Falha ao carregar: ${src}`));
                };
                document.head.appendChild(script);
            });
        }

        // Atualizar debug panel
        function updateDebugPanel() {
            if (document.getElementById('debug-panel').style.display !== 'none') {
                const dataCount = window.dadosCompletos?.length || 0;
                const mapStatus = window.mapInstance ? '‚úÖ' : '‚ùå';
                const polygonsCount = window.layerGroup?.getLayers().length || 0;
                const bairrosCount = Object.keys(window.estatisticasPorBairro || {}).length;

                document.getElementById('debug-data-count').textContent = dataCount;
                document.getElementById('debug-map-status').textContent = mapStatus;
                document.getElementById('debug-polygons-count').textContent = polygonsCount;
                document.getElementById('debug-bairros-count').textContent = bairrosCount;
            }
        }

        // Toggle debug panel
        function toggleDebugPanel() {
            const panel = document.getElementById('debug-panel');
            if (panel.style.display === 'none' || !panel.style.display) {
                panel.style.display = 'block';
                updateDebugPanel();
                setInterval(updateDebugPanel, 2000);
            } else {
                panel.style.display = 'none';
            }
        }

        // Atalho para debug (Ctrl+Shift+D)
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                e.preventDefault();
                toggleDebugPanel();
            }
        });

        // Carregar scripts em ordem SIMPLIFICADA
        async function initializeSolarMap() {
            try {
                // 1. XLSX
                updateLoadingStatus('üìö Carregando bibliotecas...', 'XLSX');
                await loadScriptSync('https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js', 'XLSX Library');

                if (typeof XLSX === 'undefined') {
                    throw new Error('XLSX n√£o foi carregado corretamente');
                }

                // 2. Dashboard com merge integrado
                updateLoadingStatus('üìä Carregando dashboard...', 'Dashboard com Merge Integrado');
                await loadScriptSync('js/dashboard.js', 'Dashboard com Merge Integrado');

                // 3. Outros m√≥dulos
                updateLoadingStatus('üó∫Ô∏è Carregando m√≥dulos...', 'Mapa');
                await loadScriptSync('js/map.js', 'Sistema de Mapas');

                updateLoadingStatus('üìà Carregando m√≥dulos...', 'Gr√°ficos');
                await loadScriptSync('js/charts.js', 'Sistema de Gr√°ficos');

                updateLoadingStatus('üîç Carregando m√≥dulos...', 'Filtros');
                await loadScriptSync('js/filters.js', 'Sistema de Filtros');

                updateLoadingStatus('üöÄ Inicializando...', 'SolarMap Dashboard');

                // Verifica√ß√µes finais
                if (typeof XLSX === 'undefined') {
                    throw new Error('XLSX n√£o dispon√≠vel');
                }

                if (typeof initializeDashboard !== 'function') {
                    throw new Error('initializeDashboard n√£o encontrada');
                }

                console.log('‚úÖ Todas as verifica√ß√µes passaram. Iniciando...');
                console.log('üìã XLSX dispon√≠vel:', typeof XLSX);
                console.log('üìã initializeDashboard dispon√≠vel:', typeof initializeDashboard);

                // Marcar como inicializado
                window.dashboardInitialized = true;

                // Inicializar dashboard (que agora tem merge integrado)
                await initializeDashboard();

                updateLoadingStatus('‚úÖ Conclu√≠do!', 'SolarMap carregado com sucesso');
                setTimeout(hideLoadingStatus, 2000);

            } catch (error) {
                console.error('‚ùå Erro na inicializa√ß√£o:', error);
                updateLoadingStatus('‚ùå Erro!', error.message);

                // Mostrar painel de debug em caso de erro
                setTimeout(() => {
                    document.getElementById('debug-panel').style.display = 'block';
                    updateDebugPanel();
                }, 1000);
            }
        }

        // Iniciar quando DOM estiver carregado
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeSolarMap);
        } else {
            initializeSolarMap();
        }

        // Exportar fun√ß√µes globais
        window.updateLoadingStatus = updateLoadingStatus;
        window.hideLoadingStatus = hideLoadingStatus;
        window.toggleDebugPanel = toggleDebugPanel;
        window.updateDebugPanel = updateDebugPanel;

    </script>
</body>
</html>
